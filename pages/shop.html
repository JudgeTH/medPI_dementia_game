<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ร้านค้า</title>
  <style>
    :root { --bg:#fff; --card:#f3f8ff; --text:#0f172a; --muted:#64748b; --shadow:0 8px 24px rgba(0,0,0,.08); }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:linear-gradient(180deg,#ffffff 0,#f8fbff 100%);border-bottom:1px solid #eef2ff;
           padding:16px 20px;display:flex;align-items:center;gap:12px;z-index:10}
    header h1{font-size:20px;margin:0 8px 0 0}
    .coins{margin-left:auto;display:flex;align-items:center;gap:8px;font-weight:700}
    .coins .star{font-size:18px}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:8px}
    .card img{width:100%;height:180px;object-fit:contain;border-radius:10px;background:#fff}
    .title{font-weight:700}
    .price{color:var(--muted)}
    .muted{color:var(--muted);font-size:14px}
    .toolbar{display:flex;align-items:center;gap:10px;margin:10px 0 20px}
    .toolbar input{padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;min-width:220px}
    .pill{padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #e2e8f0;color:#334155;font-size:12px}
    .empty{padding:24px;border:1px dashed #cbd5e1;border-radius:14px;background:#fafcff}
  </style>
  <!-- รองรับ items.js ถ้าโปรเจกต์มี (เช่นกำหนด window.SHOP_ITEMS หรือ window.ITEMS) -->
  <script>window.SHOP_ITEMS = window.SHOP_ITEMS || window.ITEMS || null;</script>
  <script src="/data/items.js" defer onerror="/* ok if missing */"></script>
</head>
<body>
  <header>
    <h1>ร้านค้า</h1>
    <span class="muted">เลือกอวาตาร์และไอเท็ม</span>
    <div class="coins"><span class="star">⭐</span><span id="coin-balance">0</span></div>
  </header>

  <main>
    <div class="toolbar">
      <input id="search" type="search" placeholder="ค้นหาสินค้า..." />
      <span class="pill" id="count-pill">0 รายการ</span>
    </div>
    <div id="shopRoot" class="grid" aria-live="polite"></div>
    <div id="emptyState" class="empty" style="display:none">ยังไม่มีสินค้าให้แสดง</div>
  </main>

  <script>
  (function(){
    // ---------- SAFE HELPERS ----------
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const toInt = (v,d=0)=> (Number.isFinite(+v)? +v: d);
    function uid(){ const k='current_uid'; let id=localStorage.getItem(k); if(!id){ id='guest'; localStorage.setItem(k,id);} return id; }

    // ---------- COINS ----------
    async function getBalance(){
      // 1) ใช้ระบบเดิมถ้ามี
      try{
        if (window.App?.economy?.getStarBalance) return await window.App.economy.getStarBalance(uid());
        if (window.App?.economy?.balance) return await window.App.economy.balance(uid());
      }catch(e){}
      // 2) ledger → stars_ledger:<uid>
      try{
        const led = JSON.parse(localStorage.getItem(`stars_ledger:${uid()}`)||'[]');
        if (Array.isArray(led) && led.length) return led.reduce((s,r)=>s+(r.delta||0),0);
      }catch(e){}
      // 3) fallback คีย์เก่า
      return toInt(localStorage.getItem('player_coins')||'0',0);
    }
    async function refreshCoins(){ $('#coin-balance').textContent = await getBalance(); }

    // ---------- ITEMS LOADER ----------
    async function loadItems(){
      // A) ถ้ามี items.js ให้รอจนโหลด (defer) แล้วอ่าน window.SHOP_ITEMS/ITEMS
      await new Promise(r => setTimeout(r, 0));
      if (Array.isArray(window.SHOP_ITEMS)) return window.SHOP_ITEMS;

      // B) พยายามอ่าน /data/items.json
      try{
        const res = await fetch('/data/items.json',{cache:'no-store'});
        if (res.ok) return await res.json();
      }catch(e){}

      // C) เผื่ออีกชื่อหนึ่ง
      try{
        const res2 = await fetch('/data/avatars.json',{cache:'no-store'});
        if (res2.ok) return await res2.json();
      }catch(e){}

      // D) DEFAULT (เอารูป base ของอาจารย์)
      return [
        { id:'elderly_male_base',   name:'ผู้ชายสูงวัย',  type:'avatar', price:0,  asset:'/assets/images/characters/base/elderly_male_base.png' },
        { id:'elderly_female_base', name:'ผู้หญิงสูงวัย', type:'avatar', price:0,  asset:'/assets/images/characters/base/elderly_female_base.png' }
      ];
    }

    // ---------- RENDER ----------
    function render(items){
      const root = $('#shopRoot');
      const empty = $('#emptyState');
      const count = $('#count-pill');
      if (!items || !items.length){ root.innerHTML=''; empty.style.display='block'; count.textContent='0 รายการ'; return; }
      empty.style.display='none';
      count.textContent = items.length + ' รายการ';
      root.innerHTML = items.map(it => `
        <div class="card">
          <img src="${it.asset||''}" alt="${it.name||''}" onerror="this.style.opacity=.3" />
          <div class="title">${it.name||'-'}</div>
          <div class="price">⭐ ${toInt(it.price,0)}</div>
        </div>
      `).join('');
    }

    // ---------- FILTER ----------
    function attachSearch(all){
      const inp = $('#search');
      inp.addEventListener('input', ()=>{
        const q = inp.value.trim().toLowerCase();
        const filtered = all.filter(it => (it.name||'').toLowerCase().includes(q));
        render(filtered);
      });
    }

    // ---------- BOOT ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      // ไม่บังคับล็อกอิน: ถ้าไม่มีจะตั้ง guest ให้อัตโนมัติ
      uid();
      refreshCoins();

      const items = await loadItems();
      render(items);
      attachSearch(items);

      document.addEventListener('coins:changed', refreshCoins);
    });
  })();
  </script>
</body>
</html>
