<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>เกมเปิดแผ่นป้าย 7 ใบ | Clue Flip Quiz</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111111; --muted:#6b7280; --accent:#111111;
      --tile-cover:#e5e7eb; --tile-open:#f8fafc; --tile-border:#d1d5db;
      --radius:20px; --shadow:0 6px 20px rgba(0,0,0,.08);
      --tile-w:min(220px, 40vw); --tile-h:min(140px, 28vw);
      --maxw:980px;
    }
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, "Noto Sans Thai", sans-serif; background:var(--bg); color:var(--fg)}

    .container{max-width:var(--maxw); margin:0 auto; padding:16px}

    /* ===== Senior-friendly type scale ===== */
    h1{font-size: clamp(22px, 4vw, 34px); margin:0 0 8px 0; letter-spacing:.5px}
    h2{font-size: clamp(18px, 3.5vw, 26px); margin:0}
    p,button,input,label{font-size: clamp(18px, 2.8vw, 20px)}

    /* ===== Panels ===== */
    .panel{background:#fff; border:2px solid #e5e7eb; border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}

    /* ===== Hint board on top ===== */
    .board{margin-bottom:14px}
    .grid{display:grid; gap:12px; grid-template-columns: repeat(3, var(--tile-w)); justify-content:center}
    @media (max-width:700px){ .grid{grid-template-columns: repeat(2, 1fr)} }

    .tile{position:relative; width:var(--tile-w); height:var(--tile-h); border-radius:18px; border:2px solid var(--tile-border);
      background:var(--tile-cover); display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; text-align:center;
      padding:12px; transition: transform .12s ease, background .2s ease, border-color .2s ease}
    .tile:hover{transform: translateY(-2px)}
    .tile .num{position:absolute; top:8px; left:10px; font-weight:700; color:#374151}
    .tile .txt{font-weight:800; text-transform:uppercase; color:#111; letter-spacing:.6px}
    .tile.open{background:var(--tile-open)}

    /* ===== Q & Choices beneath ===== */
    .choices{display:grid; gap:12px}
    .choice{padding:16px 18px; border-radius:16px; border:2px solid #d1d5db; background:#fff; text-align:left; font-weight:800;
      text-transform:uppercase; letter-spacing:.6px; cursor:pointer}
    .choice:focus{outline:4px solid #111; outline-offset:2px}
    .choice.correct{background:#e7f9ed; border-color:#34d399}
    .choice.wrong{background:#fee2e2; border-color:#ef4444}

    /* ===== Buttons ===== */
    .btn{border:2px solid #111; background:#111; color:#fff; border-radius:12px; padding:12px 16px; cursor:pointer; font-weight:800; text-transform:uppercase}
    .btn.secondary{background:#fff; color:#111}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* ===== Hidden KPIs during play, show only in summary ===== */
    .kpi{display:none}

    /* ===== Minimal link input for tile cover ===== */
    .coverbar{display:flex; gap:8px; align-items:center; margin:8px 0 12px 0}
    .coverbar input{flex:1; padding:10px 12px; border:2px solid #d1d5db; border-radius:12px}

    /* ===== Summary Modal ===== */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.4)}
    .modal .card{background:#fff; border-radius:20px; padding:18px; max-width:560px; width:92%; border:2px solid #111}
    .summary-list{list-style:none; padding:0; margin:8px 0 0 0}
    .summary-list li{padding:8px 0; font-size: clamp(18px, 2.8vw, 20px)}
  </style>
</head>
<body>
  <div class="container">
    <header class="row" style="justify-content:space-between">
      <h1>เกมเปิดแผ่นป้าย 7 ใบ</h1>
      <button class="btn" id="btnNew">ข้อต่อไป</button>
    </header>

    <!-- Read-only link for tile cover image -->
    <div class="coverbar">
      <label for="coverUrl" style="font-weight:800">ลิงก์รูปปกแผ่นป้าย</label>
      <input id="coverUrl" type="url" placeholder="วาง URL รูป (ไม่บังคับ)" />
      <button class="btn secondary" id="applyCover">ใช้รูป</button>
    </div>

    <!-- 1) Hints board on top -->
    <section class="panel board">
      <h2 style="margin-bottom:8px">คำใบ้</h2>
      <div class="grid" id="hintGrid" aria-label="กระดานคำใบ้ 7 ใบ"></div>
    </section>

    <!-- 2) Question & choices beneath -->
    <section class="panel qa">
      <p id="qText" style="font-size: clamp(20px, 3.2vw, 24px); font-weight:900; text-transform:uppercase; margin:0 0 12px 0">–</p>
      <div class="choices" id="choices"></div>
      <div class="row" style="margin-top:12px; justify-content:space-between">
        <div style="color:var(--muted)">คลิกเปิดคำใบ้ก่อน แล้วจึงตอบ</div>
        <button class="btn secondary" id="btnRevealAll" disabled>เปิดคำใบ้ทั้งหมด</button>
      </div>
    </section>

    <!-- Hidden runtime KPIs (kept for JS but not shown) -->
    <div class="kpi" aria-hidden="true">
      <span id="timer">0.00s</span>
      <span id="kUnopened">7</span>
      <span id="kScore">0</span>
      <span id="kStars">0</span>
    </div>
  </div>

  <!-- End-of-round Summary Modal -->
  <div class="modal" id="summaryModal" role="dialog" aria-modal="true">
    <div class="card">
      <h2 style="margin:0 0 6px 0">สรุปรอบนี้</h2>
      <ul class="summary-list" id="summaryList"></ul>
      <div class="row" style="margin-top:12px; justify-content:flex-end">
        <button class="btn" id="closeSummary">เริ่มข้อถัดไป</button>
      </div>
    </div>
  </div>

  <script>
  // ===== Dataset hook =====
  const DATASET = (window.FLIP_QUESTIONS && window.FLIP_QUESTIONS.items) || (window.QUESTION_BANK || []);

  // ===== Config: tile cover image URL (optional) =====
  let TILE_COVER_URL = '';

  // ===== State =====
  const state = {
    question: null,
    opened: new Set(),
    startTs: 0,
    answered: false,
    round: 1,
    starsTotal: Number(localStorage.getItem('flipq_stars')||0),
    scoreThisRound: 0,
  };

  const els = {
    grid: document.getElementById('hintGrid'),
    qText: document.getElementById('qText'),
    choices: document.getElementById('choices'),
    kUnopened: document.getElementById('kUnopened'),
    kScore: document.getElementById('kScore'),
    kStars: document.getElementById('kStars'),
    timer: document.getElementById('timer'),
    btnNew: document.getElementById('btnNew'),
    btnRevealAll: document.getElementById('btnRevealAll'),
    summaryModal: document.getElementById('summaryModal'),
    summaryList: document.getElementById('summaryList'),
    closeSummary: document.getElementById('closeSummary'),
    coverUrl: document.getElementById('coverUrl'),
    applyCover: document.getElementById('applyCover'),
  };

  let timerId = null;

  function startTimer(){
    state.startTs = performance.now();
    stopTimer();
    timerId = setInterval(()=>{
      const elapsed = performance.now()-state.startTs;
      els.timer.textContent = (elapsed/1000).toFixed(2)+'s';
    }, 120);
  }
  function stopTimer(){ if(timerId) clearInterval(timerId); timerId = null; }

  function pickRandomQuestion(){
    if(!DATASET.length) return null;
    const idx = Math.floor(Math.random()*DATASET.length);
    return JSON.parse(JSON.stringify(DATASET[idx]));
  }

  function setupBoard(){
    els.grid.innerHTML = '';
    state.opened = new Set();
    state.answered = false;
    state.scoreThisRound = 0;
    els.kScore.textContent = '0';
    els.kUnopened.textContent = '7';
    els.btnRevealAll.disabled = false;

    const placeholders = Array.from({length:7}, (_,i)=> i);
    placeholders.forEach(i=>{
      const tile = document.createElement('button');
      tile.className = 'tile';
      tile.setAttribute('aria-label', `แผ่นป้ายหมายเลข ${i+1}`);
      tile.innerHTML = `<span class="num">#${i+1}</span><span class="txt">คลิกเพื่อดูคำใบ้</span>`;
      if(TILE_COVER_URL){ tile.style.backgroundImage = `url(${TILE_COVER_URL})`; tile.style.backgroundSize='cover'; tile.style.backgroundPosition='center'; }
      tile.addEventListener('click', ()=> openHint(i, tile));
      els.grid.appendChild(tile);
    });
  }

  function openHint(index, tileEl){
    if(state.answered) return; // lock after answered
    if(state.opened.has(index)) return;
    state.opened.add(index);
    tileEl.classList.add('open');
    tileEl.style.backgroundImage = ''; // remove cover when opened
    const hint = state.question.hints[index] || '(ไม่มีข้อมูล)';
    tileEl.querySelector('.txt').textContent = hint;
    tileEl.querySelector('.txt').style.textTransform = 'none'; // ใบ้ไม่ต้องบังคับตัวพิมพ์ใหญ่
    tileEl.querySelector('.txt').style.fontSize = 'clamp(18px, 2.8vw, 22px)';
    els.kUnopened.textContent = Math.max(0, 7 - state.opened.size);
  }

  function renderChoices(){
    els.choices.innerHTML = '';
    state.question.choices.forEach((choice, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'choice';
      btn.textContent = `${String.fromCharCode(65+idx)}. ${choice}`;
      btn.addEventListener('click', ()=> onAnswer(idx));
      els.choices.appendChild(btn);
    });
  }

  function revealAllHints(){
    const tiles = els.grid.querySelectorAll('.tile');
    tiles.forEach((tile, i)=>{
      tile.classList.add('open');
      tile.style.backgroundImage = '';
      const hint = state.question.hints[i] || '(ไม่มีข้อมูล)';
      tile.querySelector('.txt').textContent = hint;
      tile.querySelector('.txt').style.textTransform = 'none';
    });
    els.kUnopened.textContent = 0;
  }

  function onAnswer(idx){
    if(state.answered) return;
    state.answered = true;
    stopTimer();

    revealAllHints();
    els.btnRevealAll.disabled = true;
    els.grid.querySelectorAll('.tile').forEach(t=> t.style.pointerEvents='none');

    const nodes = [...document.querySelectorAll('.choice')];
    const correct = idx === state.question.answerIndex;
    nodes.forEach((n,i)=>{
      if(i === state.question.answerIndex) n.classList.add('correct');
      if(i === idx && i !== state.question.answerIndex) n.classList.add('wrong');
      n.disabled = true;
    });

    const unopened = Math.max(0, 7 - state.opened.size);
    const score = correct ? unopened : 0;
    const rt = performance.now() - state.startTs; // ms
    let bonusStars = 0;
    if(correct){ if(rt < 5000) bonusStars = 1; else if(rt < 10000) bonusStars = 0.5; }
    const starsEarned = (correct ? 1 : 0) + bonusStars;

    // Update state + hidden KPIs
    state.scoreThisRound = score;
    els.kScore.textContent = String(score);
    state.starsTotal += starsEarned;
    localStorage.setItem('flipq_stars', state.starsTotal);
    els.kStars.textContent = String(state.starsTotal);

    // Behind-the-scenes log only
    const log = JSON.parse(localStorage.getItem('flipq_logs')||'[]');
    log.push({
      at: new Date().toISOString(), qid: state.question.id, correct,
      responseMs: Math.round(rt), unopened, starsEarned, score, round: state.round
    });
    localStorage.setItem('flipq_logs', JSON.stringify(log));

    // Show end-of-round summary (timer/unopened/score/stars)
    els.summaryList.innerHTML = `
      <li><b>ผลลัพธ์:</b> ${correct ? 'ตอบถูก' : 'ตอบผิด'}</li>
      <li><b>เวลา:</b> ${(rt/1000).toFixed(2)} วินาที</li>
      <li><b>แผ่นป้ายที่ยังไม่เปิด:</b> ${unopened}</li>
      <li><b>คะแนนรอบนี้:</b> ${score}</li>
      <li><b>⭐ ดาวสะสม:</b> ${state.starsTotal} (+${starsEarned})</li>
    `;
    els.summaryModal.style.display = 'flex';
  }

  function nextRound(){
    state.round += 1;
    startNewQuestion();
  }

  function startNewQuestion(){
    state.question = pickRandomQuestion();
    if(!state.question){
      document.querySelector('.qa').innerHTML = '<p style="font-weight:800">ยังไม่มีคลังคำถาม</p>';
      return;
    }
    state.opened.clear();
    state.answered = false;
    els.qText.textContent = state.question.prompt;
    els.kStars.textContent = String(state.starsTotal);
    els.kScore.textContent = '0';
    els.kUnopened.textContent = '7';
    els.btnRevealAll.disabled = false;
    renderChoices();
    setupBoard();
    els.summaryModal.style.display = 'none';
    startTimer();
  }

  // ===== Events =====
  els.btnRevealAll.addEventListener('click', revealAllHints);
  els.btnNew.addEventListener('click', ()=>{
    if(els.summaryModal.style.display !== 'flex') return; // กดได้หลังจบรอบ
    nextRound();
  });
  els.closeSummary.addEventListener('click', nextRound);
  els.applyCover.addEventListener('click', ()=>{
    TILE_COVER_URL = els.coverUrl.value.trim();
    setupBoard(); // refresh covers
  });

  // ===== Init =====
  (function init(){ startNewQuestion(); })();
  </script>
</body>
</html>
