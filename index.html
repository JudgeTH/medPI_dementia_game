<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#4CAF50" />

  <!-- PWA Meta Tags -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="‡πÄ‡∏Å‡∏°‡∏Å‡∏∂‡πã‡∏ô‡∏™‡∏°‡∏≠‡∏á" />

  <title>‡πÄ‡∏Å‡∏°‡∏Å‡∏∂‡πã‡∏ô‡∏™‡∏°‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</title>

  <!-- CSS Files -->
  <link rel="stylesheet" href="css/reset.css" />
  <link rel="stylesheet" href="css/variables.css" />
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/animations.css" />
  <link rel="stylesheet" href="css/responsive.css" />

  <style>
    /* Character layout */
    #image-character-container .character-display-area{
      display:flex; justify-content:space-between; align-items:center;
      width:92%; max-width:980px; padding:0 16px;
    }
    #image-character-container .character-info.in-stage{ 
      order:1; text-align:left; max-width:240px; 
    }
    #image-character-container .character-container{ 
      order:2; width:220px !important; height:330px !important; 
    }
    #image-character-container .character-nameplate h3{ 
      font-size:3.5rem !important; letter-spacing:.2px; 
    }
    #image-character-container .character-stats{ gap:10px !important; }
    #image-character-container .stat-item{ font-size:1.1rem !important; }
    #image-character-container .stat-icon{
      font-size:1.6rem !important; min-width:26px !important;
    }
    #image-character-container .stat-label{ font-weight:600; }
    #image-character-container .stat-value{ font-size:1.35rem !important; }
    #image-character-container .emotion-controls{ gap:12px !important; }
    #image-character-container .emotion-btn{
      width:52px !important; height:52px !important; font-size:1.35rem !important;
    }
    #image-character-container .character-shadow{ display:none !important; }
    #image-character-container .character-container{
      width:240px !important; height:360px !important;
    }

    /* Action cards */
    .action-buttons{ padding-left:16px !important; padding-right:16px !important; }
    .action-grid{
      display:grid !important; grid-template-columns:repeat(2,1fr) !important; gap:16px !important;
    }
    .action-card{
      min-height:140px !important; padding:16px 14px !important; border-radius:16px !important;
      background-color: #EAF4FF !important; border: 1px solid #CFE3FF !important;
      box-shadow: 0 2px 8px rgba(14, 35, 69, 0.08) !important;
    }
    .action-card .action-icon{
      font-size:2.2rem !important; margin-bottom:10px !important; line-height:1 !important; opacity: 1 !important;
    }
    .action-card h3{ font-size:1.3rem !important; margin:6px 0 4px !important; color: #0A2540 !important; }
    .action-card p{ font-size:.95rem !important; color: #1F2A44 !important; opacity: 1 !important; }
    .action-card:hover{
      background-color: #E3F0FF !important; transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(14, 35, 69, 0.12) !important;
    }

    @media (max-width:768px){
      #image-character-container{ height:480px !important; }
      #image-character-container .character-container{ width:220px !important; height:330px !important; }
      #image-character-container .character-nameplate h3{ font-size:2.35rem !important; }
      #image-character-container .stat-item{ font-size:1.05rem !important; }
      #image-character-container .stat-icon{ font-size:1.5rem !important; min-width:24px !important; }
      #image-character-container .stat-value{ font-size:1.3rem !important; }
      #image-character-container .emotion-btn{ width:48px !important; height:48px !important; font-size:1.25rem !important; }
      .action-buttons{ padding-left:18px !important; padding-right:18px !important; }
      .action-grid{ gap:14px !important; }
      .action-card{ min-height:150px !important; padding:18px 16px !important; }
      .action-card .action-icon{ font-size:2.4rem !important; }
      .action-card h3{ font-size:1.35rem !important; }
    }

    /* Character display area styles */
    #character-display-area{
      --bg-green:#EFFFF4; --bg-blue:#EAF6FF; width:100%; height:500px; position:relative;
      border-radius:20px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.06); margin-bottom:30px;
    }
    #character-display-area.bg-green{background:var(--bg-green)}
    #character-display-area.bg-blue{background:var(--bg-blue)}
    #character-display-area .character-scene{width:100%;height:100%;position:relative}
    #character-display-area .character-stage{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between
    }
    #character-display-area .character-display-area{
      display:flex; align-items:center; gap:16px; z-index:10; background:transparent; box-shadow:none; padding:0
    }
    #character-display-area .character-info.in-stage{
      position:absolute; top:16px; left:24px; background:transparent; box-shadow:none; padding:0; max-width:220px; z-index:15
    }
    #character-display-area .character-nameplate{margin:0 0 6px 0; padding-bottom:6px; border-bottom:1px solid #E8E8E8}
    #character-display-area .character-nameplate h3{margin:0; font-size:1.15rem; color:#2C3E50; font-weight:800}
    #character-display-area .character-container{position:relative; width:128px; height:192px; transition:all .3s ease}
    #character-display-area .pet-slot{
      position:absolute; bottom:-4px; left:-24px; width:96px; height:96px; border-radius:16px;
      background:rgba(255,255,255,.65); backdrop-filter:blur(4px); box-shadow:0 6px 16px rgba(0,0,0,.12);
      overflow:hidden; display:flex; align-items:flex-end; justify-content:center; z-index:12
    }
    #character-display-area .pet-slot img{max-width:100%; max-height:100%; object-fit:contain; display:block}

    @media (max-width:768px){
      #character-display-area{height:360px; margin-bottom:20px}
      #character-display-area .character-stage{justify-content:center}
      #character-display-area .character-info.in-stage{top:12px; left:16px}
      #character-display-area .pet-slot{left:-16px; width:80px; height:80px}
    }

    /* Emotion effects */
    #image-character-container .effect-hearts,
    #image-character-container .effect-sparkles,
    #image-character-container .effect-thought,
    #image-character-container .effect-love{
      font-size: 2.4rem !important; top: -48px !important; text-shadow: 0 2px 6px rgba(0,0,0,.12);
    }
    @media (max-width:768px){
      #image-character-container .effect-hearts,
      #image-character-container .effect-sparkles,
      #image-character-container .effect-thought,
      #image-character-container .effect-love{
        font-size: 2.1rem !important; top: -42px !important;
      }
    }
  </style>
</head>
<body>
  <!-- ‡∏´‡∏ô‡πâ‡∏≤ Login -->
  <div id="login-page" class="page active">
    <div class="container">
      <header class="header">
        <h1 class="game-title">üß† ‡πÄ‡∏Å‡∏°‡∏Å‡∏∂‡πã‡∏ô‡∏™‡∏°‡∏≠‡∏á</h1>
        <p class="game-subtitle">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</p>
      </header>

      <main class="login-form">
        <div class="welcome-card">
          <div class="character-preview">
            <div class="character-simple">üëµ</div>
          </div>

          <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</h2>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</p>

          <form id="login-form">
            <div class="input-group">
              <label for="player-name">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
              <input
                type="text"
                id="player-name"
                name="playerName"
                placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."
                required
                minlength="2"
                maxlength="20"
              />
            </div>
            <button type="submit" class="btn btn-primary btn-large">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</button>
          </form>
        </div>
      </main>

      <footer class="footer">
        <p>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</p>
      </footer>
    </div>
  </div>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤ Dashboard -->
  <div id="dashboard-page" class="page">
    <div class="container">
      <header class="header">
        <h1>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ <span id="display-name">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</span>! üëã</h1>
        <button class="btn btn-ghost logout-btn" style="position:absolute; top:20px; right:20px;">
          ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </header>

      <main class="dashboard-content">
        <section class="character-section">
          <div id="character-display-area">
            <div class="character-loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£... ‚ö°</div>
          </div>
        </section>

        <section class="action-buttons">
          <div class="action-grid">
            <button class="action-card shop-card" id="open-shop">
              <div class="action-icon">üõí</div>
              <h3>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
              <p>‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</p>
            </button>

            <button class="action-card games-card" id="open-games">
              <div class="action-icon">üéÆ</div>
              <h3>‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</h3>
              <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏≤‡∏ò‡∏¥</p>
            </button>

            <button class="action-card stats-card" id="view-stats">
              <div class="action-icon">üìä</div>
              <h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
              <p>‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </button>

            <button class="action-card customize-card" id="customize-character">
              <div class="action-icon">‚ú®</div>
              <h3>‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß</h3>
              <p>‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </button>
          </div>
        </section>

        <!-- Mini Games Selection -->
        <section class="games-menu" id="games-selection" style="display:none;">
          <div class="games-header">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h2>
            <button class="btn btn-secondary back-to-main">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
          </div>

          <div class="games-grid">
            <button class="game-card memory-game" data-game="memory">
              <div class="game-icon">üß©</div>
              <h3>‡πÄ‡∏Å‡∏°‡∏à‡∏≥‡∏†‡∏≤‡∏û</h3>
              <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô</p>
            </button>

            <button class="game-card pattern-game" data-game="pattern">
              <div class="game-icon">üîÑ</div>
              <h3>‡πÄ‡∏Å‡∏°‡∏à‡∏≥‡∏•‡∏≥‡∏î‡∏±‡∏ö</h3>
              <p>‡∏à‡∏≥‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≥‡∏î‡∏±‡∏ö</p>
            </button>

            <button class="game-card addtion-game" data-game="addition">
              <div class="game-icon">üßÆ</div>
              <h3>‡πÄ‡∏Å‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡πá‡∏ß</h3>
              <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</p>
            </button>

            <button class="game-card logic-game" data-game="logic">
              <div class="game-icon">üí≠</div>
              <h3>‡πÄ‡∏Å‡∏°‡∏ï‡∏£‡∏£‡∏Å‡∏∞</h3>
              <div class="game-difficulty">‡∏¢‡∏≤‡∏Å</div>
            </button>
          </div>
        </section>

        <!-- Shop Section -->
        <section class="shop-menu" id="shop-section" style="display:none;">
          <div class="shop-header">
            <h2>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <div class="player-coins">
              <span class="coin-icon">‚≠ê</span>
              <span id="player-coins">0</span> ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç
            </div>
            <button class="btn btn-secondary back-to-main">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
          </div>
          <div class="shop-items" id="shop-items"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
  </div>

  <!-- JavaScript Files -->
  <script type="module">
    import * as Constants from '/js/utils/constants.js';
    import * as Storage from '/js/utils/storage.js';
    window.Constants = Constants;
    window.Storage = Storage;
  </script>
  
  <script src="js/utils/helpers.js"></script>
  <script src="js/dataManager.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/character.js"></script>
  <script src="js/pet.js"></script>
  <script src="js/economy-unified.js"></script>
  <script src="js/inventory-enhanced.js"></script>
  <script src="js/app.js"></script>

  <script>
  /* WELCOME FORM HANDLER */
  (function () {
    function startFlow(name) {
      try { localStorage.setItem('playerName', name); } catch(_) {}
      var dn = document.getElementById('display-name');
      if (dn) dn.textContent = name;
      if (typeof window.startGame === 'function') {
        try { window.startGame(name); } catch(e) { console.warn(e); }
      }
      var login = document.getElementById('login-page');
      var dash  = document.getElementById('dashboard-page');
      if (login) login.classList.remove('active');
      if (dash)  dash.classList.add('active');
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å init character ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ dashboard
      setTimeout(initCharacter, 100);
      return false;
    }

    function guardForm(form) {
      if (!form) return;
      form.setAttribute('novalidate', 'novalidate');
      form.setAttribute('onsubmit', 'return false;');

      var input = form.querySelector('#player-name, [name="playerName"], input[type="text"]');
      var submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
      
      if (submitBtn) {
        submitBtn.setAttribute('type', 'button');
        submitBtn.addEventListener('click', function () {
          var name = (input && input.value || '').trim();
          if (!name) { try { form.reportValidity && form.reportValidity(); } catch(_) {} return; }
          startFlow(name);
        });
      }

      form.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          var name = (input && input.value || '').trim();
          if (!name) { try { form.reportValidity && form.reportValidity(); } catch(_) {} return; }
          startFlow(name);
        }
      });

      form.addEventListener('submit', function (e) {
        e.stopImmediatePropagation();
        e.preventDefault();
        var name = (input && input.value || '').trim();
        if (!name) { try { form.reportValidity && form.reportValidity(); } catch(_) {} return; }
        startFlow(name);
        return false;
      }, true);
    }

    window.addEventListener('load', function () {
      var form = document.getElementById('login-form') ||
                 document.getElementById('welcome-form') ||
                 document.querySelector('form');
      guardForm(form);
    });
  })();

  /* CHARACTER INITIALIZATION */
  function initCharacter() {
    console.log('üîß Initializing character system...');
    
    if (!window.characterSystem) {
      console.error('‚ùå characterSystem not found');
      return;
    }

    const displayArea = document.getElementById('character-display-area');
    if (!displayArea) {
      console.warn('‚ö†Ô∏è character-display-area not found');
      return;
    }

    try {
      const container = window.characterSystem.setupCharacterContainer();
      displayArea.innerHTML = '';
      displayArea.appendChild(container);

      const userData = {
        displayName: localStorage.getItem('playerName') || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô',
        character: {
          gender: 'male',
          petId: 'dog_01'
        },
        stats: {
          totalStars: 0,
          totalGames: 0
        }
      };

      window.characterSystem.loadCharacter(userData);
      console.log('‚úÖ Character system initialized successfully');
    } catch (error) {
      console.error('‚ùå Error initializing character:', error);
    }
  }

  /* CHARACTER & PET PATH FIX */
  (function(){
    window.AVATAR_BASE = window.AVATAR_BASE || 'assets/images/characters/base/';
    window.PETS_BASE   = window.PETS_BASE   || 'assets/images/characters/pets/';
    const STORAGE_KEY  = 'currentPet';
    const DEFAULT_PET  = 'dog_01.png';
  
    function qs(s,r){return (r||document).querySelector(s);}
    function el(t,c){const x=document.createElement(t); if(c) x.className=c; return x;}
    function resolveFile(x){return !x ? DEFAULT_PET : (/\.(png|jpe?g|gif|webp|svg)$/i.test(x)?x:(x+'.png'));}
  
    function ensurePetSlot(){
      const container = qs('#character-display-area .character-container') ||
                        qs('.character-container');
      if (!container) return null;
      let slot = qs('.pet-slot', container);
      if (!slot){ 
        slot = el('div','pet-slot'); 
        slot.id='petSlot'; 
        slot.setAttribute('aria-label','pet'); 
        container.appendChild(slot); 
      }
      return slot;
    }
  
    function renderPet(idOrFile){
      const slot = ensurePetSlot(); 
      if(!slot) return;
      const file = resolveFile(idOrFile);
      const src  = window.PETS_BASE.replace(/\/+$/,'/') + file;
      slot.innerHTML = '';
      const img = new Image();
      img.alt='‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á'; 
      img.loading='lazy'; 
      img.decoding='async';
      img.onload  = ()=>{ console.log('‚úÖ Pet loaded:', src); };
      img.onerror = ()=>{ console.error('‚ùå Pet load error:', src); };
      img.src = src;
      slot.appendChild(img);
    }
  
    function setPet(x){
      try{ localStorage.setItem(STORAGE_KEY, x); }catch(_){}
      renderPet(x);
    }
  
    window.addEventListener('load', function(){
      setTimeout(function() {
        const saved = (function(){ 
          try{ return localStorage.getItem(STORAGE_KEY); }
          catch(_){ return null; }
        })();
        renderPet(saved || DEFAULT_PET);
      }, 500);
    });
  
    window.addEventListener('shop:petChange', function(ev){
      const v = ev && ev.detail && ev.detail.pet;
      if (v) setPet(v);
    });
  
    window.setPet = setPet;
  })();
  </script>
</body>
</html>
