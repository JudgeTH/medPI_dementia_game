<script>
/* WELCOME FORM HANDLER */
(function () {
  function initCharacter() {
    console.log('üîß Starting character initialization...');
    
    if (!window.characterSystem) {
      console.error('‚ùå window.characterSystem not found!');
      console.log('Available:', Object.keys(window).filter(k => k.includes('character')));
      return;
    }

    const displayArea = document.getElementById('character-display-area');
    if (!displayArea) {
      console.error('‚ùå character-display-area not found');
      return;
    }

    try {
      console.log('üì¶ Setting up container...');
      const container = window.characterSystem.setupCharacterContainer();
      displayArea.innerHTML = '';
      displayArea.appendChild(container);
      console.log('‚úÖ Container added to DOM');

      const userData = {
        displayName: localStorage.getItem('playerName') || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô',
        character: {
          gender: 'male',
          petId: 'dog_01'
        },
        stats: {
          totalStars: 0,
          totalGames: 0
        }
      };

      console.log('üë§ Loading character with data:', userData);
      window.characterSystem.loadCharacter(userData);
      
    } catch (error) {
      console.error('‚ùå Error in initCharacter:', error);
    }
  }

  function startFlow(name) {
    console.log('üöÄ Starting game flow for:', name);
    
    try { 
      localStorage.setItem('playerName', name); 
    } catch(e) {
      console.warn('localStorage error:', e);
    }
    
    var dn = document.getElementById('display-name');
    if (dn) dn.textContent = name;
    
    var login = document.getElementById('login-page');
    var dash  = document.getElementById('dashboard-page');
    
    if (login) login.classList.remove('active');
    if (dash)  dash.classList.add('active');
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å initCharacter ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏™‡∏î‡∏á dashboard ‡πÅ‡∏•‡πâ‡∏ß 500ms
    setTimeout(function() {
      console.log('‚è∞ Calling initCharacter...');
      initCharacter();
    }, 500);
    
    return false;
  }

  function guardForm(form) {
    if (!form) return;
    form.setAttribute('novalidate', 'novalidate');
    form.setAttribute('onsubmit', 'return false;');

    var input = form.querySelector('#player-name, [name="playerName"], input[type="text"]');
    var submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
    
    if (submitBtn) {
      submitBtn.setAttribute('type', 'button');
      submitBtn.addEventListener('click', function () {
        var name = (input && input.value || '').trim();
        if (!name) { 
          try { form.reportValidity && form.reportValidity(); } catch(_) {} 
          return; 
        }
        startFlow(name);
      });
    }

    form.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        var name = (input && input.value || '').trim();
        if (!name) { 
          try { form.reportValidity && form.reportValidity(); } catch(_) {} 
          return; 
        }
        startFlow(name);
      }
    });

    form.addEventListener('submit', function (e) {
      e.stopImmediatePropagation();
      e.preventDefault();
      var name = (input && input.value || '').trim();
      if (!name) { 
        try { form.reportValidity && form.reportValidity(); } catch(_) {} 
        return; 
      }
      startFlow(name);
      return false;
    }, true);
  }

  window.addEventListener('load', function () {
    console.log('üìÑ Page loaded, setting up form...');
    var form = document.getElementById('login-form') ||
               document.getElementById('welcome-form') ||
               document.querySelector('form');
    guardForm(form);
    console.log('‚úÖ Form guard setup complete');
  });
})();

/* CHARACTER & PET PATH FIX */
(function(){
  window.AVATAR_BASE = window.AVATAR_BASE || 'assets/images/characters/base/';
  window.PETS_BASE   = window.PETS_BASE   || 'assets/images/characters/pets/';
  const STORAGE_KEY  = 'currentPet';
  const DEFAULT_PET  = 'dog_01.png';

  function qs(s,r){return (r||document).querySelector(s);}
  function el(t,c){const x=document.createElement(t); if(c) x.className=c; return x;}
  function resolveFile(x){return !x ? DEFAULT_PET : (/\.(png|jpe?g|gif|webp|svg)$/i.test(x)?x:(x+'.png'));}

  function ensurePetSlot(){
    const container = qs('#character-display-area .character-container') ||
                      qs('.character-container');
    if (!container) return null;
    let slot = qs('.pet-slot', container);
    if (!slot){ 
      slot = el('div','pet-slot'); 
      slot.id='petSlot'; 
      slot.setAttribute('aria-label','pet'); 
      container.appendChild(slot); 
    }
    return slot;
  }

  function renderPet(idOrFile){
    const slot = ensurePetSlot(); 
    if(!slot) return;
    const file = resolveFile(idOrFile);
    const src  = window.PETS_BASE.replace(/\/+$/,'/') + file;
    slot.innerHTML = '';
    const img = new Image();
    img.alt='‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á'; 
    img.loading='lazy'; 
    img.decoding='async';
    img.onload  = ()=>{ console.log('‚úÖ Pet loaded:', src); };
    img.onerror = ()=>{ console.error('‚ùå Pet load error:', src); };
    img.src = src;
    slot.appendChild(img);
  }

  function setPet(x){
    try{ localStorage.setItem(STORAGE_KEY, x); }catch(_){}
    renderPet(x);
  }

  window.addEventListener('load', function(){
    setTimeout(function() {
      const saved = (function(){ 
        try{ return localStorage.getItem(STORAGE_KEY); }
        catch(_){ return null; }
      })();
      renderPet(saved || DEFAULT_PET);
    }, 1000);
  });

  window.addEventListener('shop:petChange', function(ev){
    const v = ev && ev.detail && ev.detail.pet;
    if (v) setPet(v);
  });

  window.setPet = setPet;
})();
</script>
